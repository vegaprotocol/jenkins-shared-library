# you can view existing configuration here: https://jenkins.ops.vega.xyz/configuration-as-code/viewExport
x-do-template: &do-template
  idleTerminationInMinutes: 10
  # jcasc job will print IDs of image if you run it
  imageId: "137757582"
  initScript: |
    curl -L -o /tmp/j-init.sh https://raw.githubusercontent.com/vegaprotocol/jenkins-shared-library/main/jcasc/scripts/init.sh
    bash /tmp/j-init.sh
  installMonitoring: false
  instanceCap: 120
  labellessJobsAllowed: false
  name: "ubuntu"
  numExecutors: 1
  regionId: "fra1"
  setupPrivateNetworking: false
  sshPort: 22
  username: "ubuntu"
  workspacePath: "/jenkins/"

jenkins:
  securityRealm:
    github:
      clientID: "91757c530663c2ef60e9"
      # encrypted with master key from the file system and stored in base64
      clientSecret: "{AQAAABAAAAAwN1QhgV1rgMAngL7+jDT8kndJ10DEVq/NUQm9A6Dg3Gpk1v2fMXFuphs6qVPNmQiTFIvcd6k1pQxGFs+kmM1teQ==}"
      githubApiUri: "https://api.github.com"
      githubWebUri: "https://github.com"
      oauthScopes: "read:org,user:email,repo"
  # restore if local action needed
  #   local:
  #     allowsSignup: false
  #     users:
  #       - id: jenkins-admin
  #         password: 08rSvDmExarvhp56r5e2
  authorizationStrategy:
    projectMatrix:
      permissions:
        - "GROUP:Agent/Build:vegaprotocol"
        - "GROUP:Credentials/View:vegaprotocol"
        - "GROUP:Job/Build:vegaprotocol"
        - "GROUP:Job/Cancel:vegaprotocol"
        - "GROUP:Job/Read:vegaprotocol"
        - "GROUP:Job/Workspace:vegaprotocol"
        - "GROUP:Overall/Read:vegaprotocol"
        - "GROUP:Run/Replay:vegaprotocol"
        - "GROUP:Run/Update:vegaprotocol"

        - "USER:Agent/Build:vega-paul"
        - "USER:Credentials/View:vega-paul"
        - "USER:Job/Build:vega-paul"
        - "USER:Job/Cancel:vega-paul"
        - "USER:Job/Read:vega-paul"
        - "USER:Job/Workspace:vega-paul"
        - "USER:Overall/Read:vega-paul"
        - "USER:Run/Replay:vega-paul"
        - "USER:Run/Update:vega-paul"

        # - "USER:Overall/Administer:jenkins-admin"

        - "GROUP:Overall/Administer:vegaprotocol*Ops"
        - "GROUP:Overall/Administer:vegaprotocol*core"

        - "USER:Overall/Administer:ValentinTrinque"
        - "USER:Overall/Administer:jeremyletang"
        - "USER:Overall/Administer:jgsbennett"
        - "USER:Overall/Administer:karlem"
        - "USER:Overall/Administer:guoguojin"
        - "USER:Overall/Administer:tommcl"

        - "USER:Overall/Read:anonymous"
  nodes:
    - permanent: &office-agent
        labelString: "generic office-system-tests core-build"
        launcher:
          inbound:
            webSocket: true
            workDirSettings:
              disabled: false
              failIfWorkDirIsMissing: false
              internalDir: "remoting"
        name: "jenkins01" # 8vCPU|16GB
        mode: EXCLUSIVE
        remoteFS: "/jenkins"
        retentionStrategy: "always"
    - permanent:
        <<: *office-agent
        labelString: "performance-tests generic office-system-tests"
        name: "jenkins02" # 12vCPU|15GB
    - permanent:
        <<: *office-agent
        labelString: "generic office-system-tests core-build"
        name: "jenkins03" # 8vCPU|16GB
    - permanent:
        <<: *office-agent
        labelString: "generic office-system-tests core-build"
        name: "jenkins04" # 6vCPU|8GB
    # - permanent:
    #     <<: *office-agent
    #     labelString: "generic office-system-tests"
    #     name: "jenkins05"
    - permanent:
        <<: *office-agent
        labelString: "generic office-system-tests core-build"
        name: "jenkins06" # 6vCPU|8GB
  clouds:
    - digitalOcean:
        authTokenCredentialId: "digitalocean-token"
        connectionRetryWait: 10
        instanceCap: 180
        name: "fra1"
        privateKeyCredentialId: "ubuntu-ansible-key"
        sshKeyId: 35449484
        templates:
          - <<: *do-template
            labelString: "test-node"
            sizeId: "s-8vcpu-16gb"
            imageId: "137757582"
          - <<: *do-template
            labelString: "g-8vcpu-32gb generic-8vcpu-32gb"
            sizeId: "g-8vcpu-32gb"
          - <<: *do-template
            labelString: "s-8vcpu-16gb generic-8vcpu-16gb"
            sizeId: "s-8vcpu-16gb"
          - <<: *do-template
            labelString: "s-4vcpu-8gb generic-4vcpu-8gb generic office-system-tests core-build"
            sizeId: "s-4vcpu-8gb"
            labellessJobsAllowed: true
          - <<: *do-template
            labelString: "s-2vcpu-4gb generic-2vcpu-4gb generic"
            sizeId: "s-2vcpu-4gb"
            labellessJobsAllowed: true
        timeoutMinutes: 10
        usePrivateNetworking: false
  systemMessage: "Welcome to Vegaprotocol Jenkins Instance :)!"
security:
  scriptApproval:
    approvedSignatures:
      - "field hudson.plugins.git.GitSCM GIT_BRANCH"
      - "field hudson.plugins.git.GitSCM GIT_CHECKOUT_DIR"
      - "field hudson.plugins.git.GitSCM GIT_COMMIT"
      - "field hudson.plugins.git.GitSCM GIT_LOCAL_BRANCH"
      - "field hudson.plugins.git.GitSCM GIT_PREVIOUS_COMMIT"
      - "field hudson.plugins.git.GitSCM GIT_REF"
      - "method groovy.json.JsonSlurperClassic parseText java.lang.String"
      - "method groovy.lang.Binding getVariables"
      - "method groovy.lang.GroovyObject invokeMethod java.lang.String java.lang.Object"
      - "method hudson.ExtensionList get java.lang.Class"
      - "method hudson.model.Saveable save"
      - "method io.jenkins.plugins.casc.CasCGlobalConfig getConfigurationPath"
      - "method io.jenkins.plugins.casc.CasCGlobalConfig setConfigurationPath java.lang.String"
      - "method io.jenkins.plugins.casc.ConfigurationAsCode configure"
      - "method org.jenkinsci.plugins.structs.describable.UninstantiatedDescribable\
        \ getArguments"
      - "new groovy.json.JsonSlurperClassic"
      - "staticMethod io.jenkins.plugins.casc.ConfigurationAsCode get"
      - "staticMethod jenkins.model.GlobalConfiguration all"
      - "staticMethod org.codehaus.groovy.runtime.DefaultGroovyMethods findAll java.lang.Object"
      - "staticMethod org.codehaus.groovy.runtime.DefaultGroovyMethods inspect java.lang.Object"
unclassified:
  globalLibraries:
    libraries:
      - defaultVersion: "main"
        name: "vega-shared-library"
        retriever:
          modernSCM:
            scm:
              github:
                configuredByUrl: true
                credentialsId: "Vega Jenkins"
                id: "626236a1-2f6f-4d28-b307-c79fe881e167"
                repoOwner: "vegaprotocol"
                repository: "jenkins-shared-library"
                repositoryUrl: "https://github.com/vegaprotocol/jenkins-shared-library"
                traits:
                  - gitHubBranchDiscovery:
                      strategyId: 1
                  - gitHubPullRequestDiscovery:
                      strategyId: 1
  simple-theme-plugin:
    elements:
      - faviconUrl:
          url: "https://vegaprotocol.github.io/jenkins-shared-library/theme/vega/vega-favicon.png"
      - jsUrl:
          url: "https://vegaprotocol.github.io/jenkins-shared-library/theme/theme.js"
      - cssUrl:
          url: "https://vegaprotocol.github.io/jenkins-shared-library/theme/theme.css"
  slackNotifier:
    botUser: false
    sendAsText: false
    teamDomain: "vegaprotocol"
    tokenCredentialId: "slack-token"
