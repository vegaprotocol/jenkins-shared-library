// https://github.com/janinko/ghprb/issues/77
def scmDefinition(args){
  return {
    cpsScm {
      scm {
        git {
          remote {
            url(args.repo)
            credentials(args.get('credentials', "vega-ci-bot"))
          }
        }
      }
      scriptPath(args.get('jenkinsfile', 'Jenkinsfile'))
    }
  }
}

def h(def text, def num=4) {
    return "<h${num}>${text}</h${num}>"
}

def standardDescription() {
    def url = "https://github.com/vegaprotocol/jenkins-shared-library/tree/main/dsl"
    return h("""
        This job was automatically generated by DSL script located at <a href="${url}">this repository</a> and processed by <a href='${binding.variables.get('JOB_URL')}'>this job</a>, any manual configuration will be overriden.
    """, 5)
}

def createCommonPipeline(args){
    args.repo = "git@github.com:vegaprotocol/${args.repo}.git"
    return pipelineJob(args.name) {
        def des = args.get('description', '')
        des += "${des ? '<br/>' : ''} ${standardDescription()}"
        description(des)
        if (args.get('githubTrigger', true)) {
            properties {
                pipelineTriggers {
                    triggers {
                        githubPush()
                    }
                }
            }
        }
        logRotator {
            daysToKeep(45)
        }
        if (args.parameters) {
            parameters args.parameters
        }
        environmentVariables {
            keepBuildVariables(true)
            keepSystemVariables(true)
            args.env.each { key, value ->
                env(key.toUpperCase(), value)
            }
        }
        if (args.get('useScmDefinition', true)) {
            definition scmDefinition(args)
            properties {
                pipelineTriggers {
                    triggers {
                        githubPush()
                    }
                }
            }
        }
        else {
            definition args.definition
        }

    }
}

def jobs = [
    [
        name: 'private/cd/capsule-test',
        description: h('To test this job edit its config and change @main in vega-shared-library pin to your branch at jenkins-shared-library repository and change function used inside the script. Your manual change will get overriden on any change to jenkins-shared-library "dsl" directory on main branch.'),
        useScmDefinition: false,
        parameters: {
            booleanParam('BUILD_CAPSULE', false, h('decide if build vegacapsule from source if false VEGACAPSULE_VERSION will be looked up in releases page', 5))
            stringParam('VEGACAPSULE_VERSION', 'v0.1.0', h('version of vegacapsule'))
            stringParam('VEGA_VERSION', 'v0.52.0', h('version of vega core'))
            stringParam('DATA_NODE_VERSION', 'v0.52.0', h('version of data node'))
        },
        definition: {
            cps {
                script("""
                    @Library('vega-shared-library@main') _
                    capsulePipeline()
                """)
                sandbox()
            }
        },
    ],
    [
        name: 'private/DSL Job',
        repo: 'jenkins-shared-library',
        description: h('this job is used to generate other jobs'),
        jenkinsfile: 'dsl/Jenkinsfile',
    ]
]

jobs.each { job ->
    createCommonPipeline(job)
}