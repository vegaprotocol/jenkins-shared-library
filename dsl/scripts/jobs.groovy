// https://github.com/janinko/ghprb/issues/77
def standardDefinition(args){
  return {
    cpsScm {
      scm {
        git {
          remote {
            url(args.repo)
            credentials(args.get('credentials', "vega-ci-bot"))
          }
        }
      }
      scriptPath(args.get('jenkinsfile', 'Jenkinsfile'))
    }
  }
}

def standardDescription() {
    def url = "https://github.com/vegaprotocol/jenkins-shared-library/tree/main/dsl"
    return  """
        <h3>
        This job was automatically generated by DSL script located at <a href="${url}">this repository</a> and processed by <a href='${binding.variables.get('JOB_URL')}'>this job</a>, any manual configuration will be overriden.
        </h3>
    """
}

def createCommonPipeline(args){
    args.repo = "git@github.com:vegaprotocol/${args.repo}.git"
    return pipelineJob(args.name) {
        description(standardDescription())
        if (args.get('githubTrigger', true)) {
            properties {
                pipelineTriggers {
                    triggers {
                        githubPush()
                    }
                }
            }
        }
        logRotator {
            daysToKeep(45)
        }
        if (args.triggers) {
            triggers args.triggers
        }
        environmentVariables {
            keepBuildVariables(true)
            keepSystemVariables(true)
            args.env.each { key, value ->
                env(key.toUpperCase(), value)
            }
        }
        definition standardDefinition(args)
    }
}

def jobs = [
    [
        name: 'ansible SSH',
        // parsed on Jenkinsfile level
        env: [
            ANSIBLE_ARGS: '--tags ssh',
            // do double groovy escape \\ to do single escape for regex -> \/
            CHANGESET: 'group_vars\\/all.yaml|roles\\/accounts\\/.*|inventories\\/.*'
        ],
        repo: 'ansible',
        jenkinsfile: 'jenkins/run.Jenkinsfile'
    ]
]

jobs.each { job ->
    createCommonPipeline(job)
}